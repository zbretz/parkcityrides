<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Park City Rides – Create an Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    .step-hidden{display:none}
    .ring-focus:focus{outline:none;box-shadow:0 0 0 4px rgba(255,255,255,.2)}
  </style>
</head>
<body class="min-h-screen bg-black text-white">
  <!-- Header -->
  <header class="border-b border-white/10">
    <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-4">
      <a href="/" class="flex items-center gap-3" aria-label="Park City Rides Home">
        <img src="/logo.png" alt="Park City Rides Logo"
             class="h-9 w-9 rounded-2xl ring-1 ring-white/15 object-cover" />
        <span class="text-lg font-semibold tracking-tight">Park City Rides</span>
      </a>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-10">
    <h1 class="text-3xl font-semibold">Create an account</h1>
    <p class="mt-2 text-white/70">A simple three-step signup: details → CAPTCHA → card on file.</p>

    <!-- Progress -->
    <ol class="mt-6 grid grid-cols-3 gap-3 text-xs text-white/70">
      <li id="p1" class="rounded-xl bg-white/10 px-3 py-2 text-center font-medium text-white">1 · Your details</li>
      <li id="p2" class="rounded-xl bg-white/5 px-3 py-2 text-center">2 · CAPTCHA</li>
      <li id="p3" class="rounded-xl bg-white/5 px-3 py-2 text-center">3 · Card on file</li>
    </ol>

    <form id="signupForm" class="mt-8 space-y-8" novalidate>
      <!-- STEP 1: ACCOUNT DETAILS -->
      <section id="step1" aria-labelledby="step1label">
        <h2 id="step1label" class="text-xl font-semibold">Your details</h2>
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="fullName" class="block text-sm text-white/80">Full name</label>
            <input id="fullName" name="fullName" type="text" required autocomplete="name" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="Jane Doe" />
          </div>
          <div>
            <label for="email" class="block text-sm text-white/80">Email</label>
            <input id="email" name="email" type="email" required autocomplete="email" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="jane@example.com" />
          </div>
          <div>
            <label for="phone" class="block text-sm text-white/80">Mobile phone</label>
            <input id="phone" name="phone" type="tel" inputmode="tel" pattern="[0-9()+\-\s]{7,}" required autocomplete="tel" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="(801) 555-1234" />
          </div>
          <div class="sm:col-span-2">
            <label for="address" class="block text-sm text-white/80">Home address</label>
            <input id="address" name="address" type="text" required autocomplete="street-address" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="123 Main St, Park City, UT 84060" />
          </div>
          <div>
            <label for="local" class="block text-sm text-white/80">Are you a Park City local?</label>
            <select id="local" name="local" required class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus">
              <option value="" disabled selected>Choose one</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="seasonal">Seasonal</option>
            </select>
          </div>
          <div>
            <label for="partySize" class="block text-sm text-white/80">Typical party size</label>
            <select id="partySize" name="partySize" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus">
              <option value="1-2">1–2</option>
              <option value="3-4">3–4</option>
              <option value="5-6">5–6</option>
              <option value="7+">7+</option>
            </select>
          </div>
          <div>
            <label for="luggage" class="block text-sm text-white/80">Usual luggage/gear</label>
            <select id="luggage" name="luggage" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus">
              <option value="light">Light</option>
              <option value="ski">Ski/Snowboard</option>
              <option value="golf">Golf clubs</option>
              <option value="child">Child seats</option>
            </select>
          </div>
          <div>
            <label for="notes" class="block text-sm text-white/80">Notes / preferences (optional)</label>
            <input id="notes" name="notes" type="text" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="Gate codes, child seats, accessibility" />
          </div>
        </div>
        <div class="mt-6 flex items-center justify-end gap-3">
          <button type="button" id="toStep2" class="rounded-xl bg-white px-5 py-3 text-sm font-semibold text-black hover:bg-white/90">Continue to CAPTCHA</button>
        </div>
      </section>

      <!-- STEP 2: CAPTCHA -->
      <section id="step2" class="step-hidden" aria-labelledby="step2label">
        <h2 id="step2label" class="text-xl font-semibold">Verify you’re human</h2>
        <p class="mt-2 text-white/70 text-sm">This prevents spam. In production, embed Google reCAPTCHA or hCaptcha here.</p>
        <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-6">
          <!-- Placeholder CAPTCHA box -->
          <div class="mx-auto flex max-w-sm items-center justify-between rounded-xl border border-white/15 bg-black/40 px-4 py-4">
            <div class="flex items-center gap-3">
              <input type="checkbox" id="fakeCaptcha" class="h-5 w-5 rounded border-white/20 bg-white/5" />
              <label for="fakeCaptcha" class="text-sm text-white/80">I’m not a robot</label>
            </div>
            <span class="text-xs text-white/50">CAPTCHA</span>
          </div>
        </div>
        <div class="mt-6 flex items-center justify-between">
          <button type="button" id="back1" class="rounded-xl bg-white/10 px-5 py-3 text-sm font-semibold text-white hover:bg-white/15">Back</button>
          <button type="button" id="toStep3" class="rounded-xl bg-white px-5 py-3 text-sm font-semibold text-black hover:bg-white/90">Continue to Card</button>
        </div>
      </section>

      <!-- STEP 3: CARD ON FILE -->
      <section id="step3" class="step-hidden" aria-labelledby="step3label">
        <h2 id="step3label" class="text-xl font-semibold">Add a card on file</h2>
        <p class="mt-2 text-white/70 text-sm">
          By adding a card on file, you agree that Park City Rides may charge your card at our discretion for rides, fees, or membership costs.
        </p>

        <!-- Validation/submit feedback -->
        <div id="cardNotice" class="mt-3 hidden rounded-xl border border-yellow-500/40 bg-yellow-500/10 px-4 py-3 text-sm text-yellow-300"></div>

        <div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label class="block text-sm text-white/80">Name on card</label>
            <input type="text" id="cardName" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" placeholder="Jane Doe" required />
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm text-white/80">Card details</label>
            <div class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-6">
              <input id="cardNumber" type="text" inputmode="numeric" placeholder="4242 4242 4242 4242" class="sm:col-span-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" />
              <input id="cardExp"    type="text" inputmode="numeric" placeholder="MM/YY" class="sm:col-span-1 rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" />
              <input id="cardCvc"    type="text" inputmode="numeric" placeholder="CVC" class="sm:col-span-1 rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" />
              <input id="cardZip"    type="text" inputmode="numeric" placeholder="ZIP" class="sm:col-span-1 rounded-xl border border-white/10 bg-white/5 px-4 py-3 ring-focus" />
            </div>
          </div>
          <div class="sm:col-span-2 flex items-start gap-3">
            <input id="agreeBilling" type="checkbox" required class="mt-1 h-5 w-5 rounded border-white/20 bg-white/5" />
            <label for="agreeBilling" class="text-sm text-white/80">I authorize Park City Rides to securely store and charge my card for rides and applicable fees.</label>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between">
          <button type="button" id="back2" class="rounded-xl bg-white/10 px-5 py-3 text-sm font-semibold text-white hover:bg-white/15">Back</button>

          <!-- Submit with spinner -->
          <button id="submitBtn" type="submit"
                  class="inline-flex items-center gap-2 rounded-xl bg-white px-5 py-3 text-sm font-semibold text-black hover:bg-white/90">
            <svg id="spinner" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span id="submitText">Create account</span>
          </button>
        </div>
      </section>
    </form>
  </main>

  <script>
    // ------- step navigation -------
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const p1 = document.getElementById('p1');
    const p2 = document.getElementById('p2');
    const p3 = document.getElementById('p3');

    const show = (s) => {
      [step1, step2, step3].forEach(el => el.classList.add('step-hidden'));
      s.classList.remove('step-hidden');
      p1.className = 'rounded-xl px-3 py-2 text-center';
      p2.className = 'rounded-xl px-3 py-2 text-center';
      p3.className = 'rounded-xl px-3 py-2 text-center';
      if (s===step1){p1.classList.add('bg-white/10','text-white','font-medium'); p2.classList.add('bg-white/5','text-white/80'); p3.classList.add('bg-white/5','text-white/80');}
      if (s===step2){p2.classList.add('bg-white/10','text-white','font-medium'); p1.classList.add('bg-white/5','text-white/80'); p3.classList.add('bg-white/5','text-white/80');}
      if (s===step3){p3.classList.add('bg-white/10','text-white','font-medium'); p1.classList.add('bg-white/5','text-white/80'); p2.classList.add('bg-white/5','text-white/80');}
    };

    document.getElementById('toStep2').addEventListener('click', () => {
      const required = ['fullName','email','phone','address','local']; // removed 'accept'
      for (const id of required){
        const el = document.getElementById(id);
        if (el && !el.checkValidity()) { el.reportValidity(); return; }
        if (el && el.type==='checkbox' && !el.checked){ el.focus(); return; }
      }
      show(step2);
      window.scrollTo({top:0, behavior:'smooth'});
    });

    document.getElementById('back1').addEventListener('click', () => { show(step1); window.scrollTo({top:0, behavior:'smooth'}); });

    document.getElementById('toStep3').addEventListener('click', () => {
      const cb = document.getElementById('fakeCaptcha');
      if (!cb.checked){ cb.focus(); return; }
      show(step3);
      window.scrollTo({top:0, behavior:'smooth'});
    });

    document.getElementById('back2').addEventListener('click', () => { show(step2); window.scrollTo({top:0, behavior:'smooth'}); });

    // ------- card validation helpers -------
    const onlyDigits = (s) => (s || '').replace(/\D/g, '');

    function detectCardType(num) {
      if (/^4\d*/.test(num)) return 'visa';
      if (/^(5[1-5]|2(2[2-9]|[3-6]\d|7[01]|720))\d*/.test(num)) return 'mc';
      if (/^3[47]\d*/.test(num)) return 'amex';
      if (/^6(011|5)\d*/.test(num)) return 'discover';
      return 'unknown';
    }

    function luhnCheck(num) {
      let sum = 0, alt = false;
      for (let i = num.length - 1; i >= 0; i--) {
        let n = +num[i];
        if (alt) { n *= 2; if (n > 9) n -= 9; }
        sum += n; alt = !alt;
      }
      return sum % 10 === 0;
    }

    function validateCardNumber(raw) {
      const digits = onlyDigits(raw);
      if (digits.length < 13) return { ok: false, msg: 'Card number is too short.' };
      const type = detectCardType(digits);
      const validLength =
        (type === 'amex' && digits.length === 15) ||
        (type !== 'amex' && digits.length === 16);
      if (!validLength) return { ok: false, msg: 'Card number length looks incorrect.' };
      if (!luhnCheck(digits)) return { ok: false, msg: 'Card number failed validation.' };
      return { ok: true, type };
    }

    function validateExpiry(raw) {
      const s = (raw || '').trim();
      const m = s.match(/^(\d{1,2})\s*\/\s*(\d{2}|\d{4})$/);
      if (!m) return { ok: false, msg: 'Use MM/YY (e.g., 08/27).' };
      let mm = +m[1], yy = m[2].length === 2 ? 2000 + +m[2] : +m[2];
      if (mm < 1 || mm > 12) return { ok: false, msg: 'Invalid month.' };
      const now = new Date();
      const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const expMonth = new Date(yy, mm - 1, 1);
      if (expMonth < thisMonth) return { ok: false, msg: 'Card is expired.' };
      if (yy > now.getFullYear() + 20) return { ok: false, msg: 'Expiry year is too far out.' };
      return { ok: true };
    }

    function validateCvc(raw, brand) {
      const digits = onlyDigits(raw);
      if (brand === 'amex') {
        if (digits.length !== 4) return { ok: false, msg: 'AmEx CVC is 4 digits.' };
      } else {
        if (digits.length !== 3) return { ok: false, msg: 'CVC should be 3 digits.' };
      }
      return { ok: true };
    }

    function validateUSZip(raw) {
      const s = (raw || '').trim();
      if (!/^\d{5}(-\d{4})?$/.test(s)) return { ok: false, msg: 'ZIP should be 5 or 9 digits.' };
      return { ok: true };
    }

    // inline error UI
    function showError(inputEl, msg) {
      clearError(inputEl);
      inputEl.classList.add('ring-2','ring-red-500');
      const hint = document.createElement('p');
      hint.className = 'mt-1 text-xs text-red-400';
      hint.dataset.err = 'true';
      hint.textContent = msg;
      inputEl.insertAdjacentElement('afterend', hint);
    }
    function clearError(inputEl) {
      inputEl.classList.remove('ring-2','ring-red-500');
      const next = inputEl.nextElementSibling;
      if (next && next.dataset && next.dataset.err) next.remove();
    }

    // ------- submit with validation + spinner + friendly failure -------
    const form = document.getElementById('signupForm');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const submitText = document.getElementById('submitText');
    const notice = document.getElementById('cardNotice');

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const agree = document.getElementById('agreeBilling');
      if (!agree.checked){ agree.focus(); return; }

      const numEl = document.getElementById('cardNumber');
      const expEl = document.getElementById('cardExp');
      const cvcEl = document.getElementById('cardCvc');
      const zipEl = document.getElementById('cardZip');
      const nameEl = document.getElementById('cardName');

      // clear old errors & notice
      [nameEl,numEl,expEl,cvcEl,zipEl].forEach(el => el && clearError(el));
      notice.classList.add('hidden');
      notice.textContent = '';

      // basic presence check
      if (!nameEl.value.trim()) { showError(nameEl, 'Name on card is required.'); nameEl.focus(); return; }

      // validate card fields
      let ok = true;
      const numRes = validateCardNumber(numEl.value); if (!numRes.ok) { showError(numEl, numRes.msg); ok = false; }
      const expRes = validateExpiry(expEl.value);     if (!expRes.ok) { showError(expEl, expRes.msg); ok = false; }
      const cvcRes = validateCvc(cvcEl.value, numRes.type); if (!cvcRes.ok) { showError(cvcEl, cvcRes.msg); ok = false; }
      const zipRes = validateUSZip(zipEl.value);      if (!zipRes.ok) { showError(zipEl, zipRes.msg); ok = false; }

      if (!ok) {
        const firstBad = [nameEl,numEl,expEl,cvcEl,zipEl].find(el => {
          const n = el.nextElementSibling; return n && n.dataset && n.dataset.err;
        });
        if (firstBad) firstBad.focus();
        return;
      }

      // show spinner / "processing"
      submitBtn.disabled = true;
      spinner.classList.remove('hidden');
      submitText.textContent = 'Processing...';

      // Simulate failing to store card (no actual storage)
      setTimeout(() => {
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
        submitText.textContent = 'Create account';

        notice.textContent = 'We were not able to store the card. Please call support and we’ll get you set up right away.';
        notice.classList.remove('hidden');
      }, 1200);
    });
  </script>
</body>
</html>
